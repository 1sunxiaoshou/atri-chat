# 日志系统说明

## 概述

项目使用 `loguru` 作为日志框架，实现了分类日志记录和多文件输出。

## 日志分类

日志按功能分为以下几类：

### 1. API 日志 (`api.log`)
- **用途**: 记录 HTTP 请求和响应
- **内容**: 请求方法、路径、状态码、处理时间、客户端 IP
- **级别**: INFO 及以上
- **示例**:
  ```
  → GET /api/characters
  ← GET /api/characters 200 | 0.123s
  ```

### 2. 业务逻辑日志 (`business.log`)
- **用途**: 记录核心业务流程
- **内容**: Agent 创建、消息处理、会话管理等
- **级别**: INFO 及以上
- **模块**: `agent_manager.py`

### 3. 数据库操作日志 (`database.log`)
- **用途**: 记录数据库 CRUD 操作
- **内容**: 角色、会话、消息的增删改查
- **级别**: DEBUG 及以上
- **模块**: `storage.py`, `store.py`

### 4. 模型调用日志 (`model.log`)
- **用途**: 记录 LLM、ASR、TTS 模型的创建和调用
- **内容**: 模型实例化、配置变更、缓存命中
- **级别**: INFO 及以上
- **模块**: `models/factory.py`, `asr/factory.py`, `tts/factory.py`

### 5. 性能日志 (`performance.log`)
- **用途**: 记录函数执行时间
- **内容**: 函数名、执行耗时
- **级别**: INFO 及以上
- **装饰器**: `@log_performance`

### 6. 错误日志 (`error.log`)
- **用途**: 记录所有错误和异常
- **内容**: 错误堆栈、上下文信息
- **级别**: ERROR 及以上
- **保留**: 30 天

### 7. 综合日志 (`app.log`)
- **用途**: 记录所有日志
- **级别**: DEBUG 及以上
- **保留**: 7 天

## 使用方法

### 基本用法

```python
from core.logger import get_logger

# 创建 logger 实例（指定分类）
logger = get_logger(__name__, category="BUSINESS")

# 记录日志
logger.debug("调试信息", extra={"key": "value"})
logger.info("普通信息", extra={"user_id": 123})
logger.warning("警告信息")
logger.error("错误信息", exc_info=True)
```

### 日志分类

可用的分类：
- `API` - API 请求日志
- `BUSINESS` - 业务逻辑日志
- `DATABASE` - 数据库操作日志
- `MODEL` - 模型调用日志
- `PERFORMANCE` - 性能日志
- `GENERAL` - 通用日志（默认）

### 使用装饰器

#### 性能日志装饰器

```python
from core.tools.logger_utils import log_performance

@log_performance
async def expensive_operation():
    # 自动记录执行时间
    pass
```

#### 操作日志装饰器

```python
from core.tools.logger_utils import log_operation

@log_operation("创建用户", category="BUSINESS")
def create_user(name: str):
    # 自动记录操作开始和完成
    pass
```

### 结构化日志

使用 `extra` 参数添加结构化信息：

```python
logger.info(
    "用户登录成功",
    extra={
        "category": "BUSINESS",
        "user_id": 123,
        "ip": "192.168.1.1",
        "device": "mobile"
    }
)
```

## 日志配置

### 日志级别控制

#### 通过环境变量设置

在 `.env` 文件中配置：
```bash
# 日志级别: TRACE, DEBUG, INFO, SUCCESS, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO
```

#### 启动时设置

```bash
# Windows
set LOG_LEVEL=DEBUG && python main.py

# Linux/Mac
LOG_LEVEL=DEBUG python main.py
```

#### 运行时动态修改

```python
from core.logger import set_log_level, get_log_level

# 查看当前级别
print(get_log_level())  # INFO

# 修改日志级别
set_log_level("DEBUG")
```

### 日志级别说明
- `TRACE`: 最详细的追踪信息（很少使用）
- `DEBUG`: 详细的调试信息（开发环境推荐）
- `INFO`: 一般信息（生产环境推荐）
- `SUCCESS`: 成功操作信息
- `WARNING`: 警告信息（生产环境推荐）
- `ERROR`: 错误信息
- `CRITICAL`: 严重错误

### 文件轮转
- 大小轮转: 当文件超过指定大小时自动创建新文件
- 时间保留: 自动删除过期日志

## 最佳实践

### 1. 选择合适的日志级别

**开发环境**:
```bash
LOG_LEVEL=DEBUG  # 查看所有详细信息
```

**测试环境**:
```bash
LOG_LEVEL=INFO   # 查看关键流程
```

**生产环境**:
```bash
LOG_LEVEL=WARNING  # 只记录警告和错误
# 或
LOG_LEVEL=INFO     # 记录关键业务流程
```

**代码中的使用**:
- `DEBUG`: 开发调试时使用，生产环境可关闭
- `INFO`: 记录重要的业务流程节点
- `WARNING`: 记录可能的问题，但不影响运行
- `ERROR`: 记录错误和异常

### 2. 添加上下文信息
```python
# 好的做法
logger.info(
    "创建 Agent 成功",
    extra={
        "character_id": character_id,
        "model": f"{provider_id}/{model_id}",
        "tool_count": len(tools)
    }
)

# 不好的做法
logger.info("创建 Agent 成功")
```

### 3. 异常处理
```python
try:
    risky_operation()
except Exception as e:
    logger.error(
        "操作失败",
        extra={"operation": "risky_operation", "error": str(e)},
        exc_info=True  # 包含完整堆栈
    )
    raise
```

### 4. 避免敏感信息
不要记录：
- 密码、API Key
- 用户隐私数据
- 完整的请求/响应体（如果包含敏感信息）

### 5. 性能考虑
- 避免在循环中记录大量 DEBUG 日志
- 使用 `extra` 而不是字符串拼接
- 生产环境可以提高日志级别到 INFO

## 日志查看

### 实时查看
```bash
# Windows
type logs\app.log
Get-Content logs\app.log -Tail 50 -Wait

# 查看特定分类
type logs\business.log
type logs\error.log
```

### 日志分析
- 使用文本编辑器搜索关键字
- 使用日志分析工具（如 ELK、Grafana Loki）
- 编写脚本解析 JSON 格式的日志

## 故障排查

### 常见问题

1. **日志文件过大**
   - 检查是否有循环日志
   - 调整轮转策略
   - 提高日志级别

2. **找不到日志**
   - 检查 `logs/` 目录是否存在
   - 检查文件权限
   - 查看控制台输出

3. **日志信息不完整**
   - 确保使用了 `exc_info=True`
   - 检查日志级别配置
   - 添加更多 `extra` 信息

## 扩展

### 添加新的日志分类

在 `core/logger.py` 中添加新的日志处理器：

```python
logger.add(
    LOG_DIR / "new_category.log",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {message}",
    level="INFO",
    filter=lambda record: record["extra"].get("category") == "NEW_CATEGORY",
    rotation="100 MB",
    retention="7 days",
    encoding="utf-8",
)
```

### 集成外部日志系统

可以添加自定义 handler 将日志发送到：
- Sentry（错误追踪）
- Elasticsearch（日志搜索）
- CloudWatch（云端日志）
- Slack/钉钉（告警通知）
