# 模型管理模块文档

## 概述

模型管理模块提供了统一的模型配置和创建接口，支持多种 AI 供应商（OpenAI、通义千问、Anthropic、Google 等）的文本模型和嵌入模型。采用工厂模式和注册表模式，支持动态扩展自定义供应商。

## 核心组件

### 1. ModelConfig - 模型配置

定义模型的基本配置信息。

```python
from core.models import ModelConfig, ModelType

# 创建文本模型配置
model_config = ModelConfig(
    model_id="gpt-4o-mini",
    provider_id="openai",
    model_type=ModelType.TEXT,
    mode="chat",
    enabled=True
)

# 创建嵌入模型配置
embedding_config = ModelConfig(
    model_id="text-embedding-3-small",
    provider_id="openai",
    model_type=ModelType.EMBEDDING,
    mode="dense",
    enabled=True
)
```

**字段说明：**
- `model_id`: 模型标识符（如 "gpt-4o-mini"）
- `provider_id`: 供应商标识符（如 "openai"、"tongyi"）
- `model_type`: 模型类型（TEXT/EMBEDDING/RERANK）
- `mode`: 模型模式（文本模型：llm/chat/vision，嵌入模型：dense）
- `enabled`: 是否启用该模型

### 2. ProviderConfig - 供应商配置

定义供应商的连接和认证信息。

```python
from core.models import ProviderConfig

provider_config = ProviderConfig(
    provider_id="openai",
    config_json={
        "api_key": "sk-xxx",
        "base_url": "https://api.openai.com/v1",
        "temperature": 0.7,
        "max_tokens": 4096
    }
)
```

### 3. ModelFactory - 模型工厂

负责根据配置创建实际的模型实例。

```python
from core.models import ModelFactory
from core.storage import AppStorage

# 初始化
storage = AppStorage("data/app.db")
factory = ModelFactory(storage)

# 创建模型实例
model = factory.create_model(
    provider_id="openai",
    model_id="gpt-4o-mini"
)

# 使用模型
response = model.invoke("你好，世界！")
print(response.content)
```

## 支持的供应商

### 内置供应商

| 供应商 | provider_id | 文本模型 | 嵌入模型 |
|--------|-------------|----------|----------|
| OpenAI | openai | ✓ | ✓ |
| 通义千问 | tongyi | ✓ | ✗ |
| Anthropic | anthropic | ✓ | ✗ |
| Google | google | ✓ | ✓ |

### 扩展自定义供应商

```python
def create_custom_text_model(model_config, provider_config):
    """自定义文本模型创建函数"""
    from langchain_community.chat_models import ChatCustom
    config = provider_config.config_json
    return ChatCustom(
        model=model_config.model_id,
        api_key=config.get("api_key"),
        # 其他参数...
    )

# 注册自定义供应商
factory.register_text_model_creator("custom", create_custom_text_model)

# 使用自定义供应商
model = factory.create_model("custom", "custom-model-v1")
```

## 使用示例

### 示例 1：配置和使用 OpenAI 模型

```python
from core.storage import AppStorage
from core.models import ModelFactory

# 1. 初始化存储和工厂
storage = AppStorage("data/app.db")
factory = ModelFactory(storage)

# 2. 添加供应商配置
storage.add_provider(
    provider_id="openai",
    config_json={
        "api_key": "sk-xxx",
        "base_url": "https://api.openai.com/v1",
        "temperature": 0.7
    }
)

# 3. 添加模型配置
storage.add_model(
    model_id="gpt-4o-mini",
    provider_id="openai",
    model_type="text",
    mode="chat"
)

# 4. 创建并使用模型
model = factory.create_model("openai", "gpt-4o-mini")
response = model.invoke("解释什么是 LangChain")
print(response.content)
```

### 示例 2：使用嵌入模型

```python
# 添加嵌入模型配置
storage.add_model(
    model_id="text-embedding-3-small",
    provider_id="openai",
    model_type="embedding",
    mode="dense"
)

# 创建嵌入模型
embeddings = factory.create_model("openai", "text-embedding-3-small")

# 生成向量
vectors = embeddings.embed_documents([
    "这是第一段文本",
    "这是第二段文本"
])
print(f"向量维度: {len(vectors[0])}")
```

### 示例 3：切换模型

```python
# 禁用当前模型
storage.update_model("openai", "gpt-4o-mini", enabled=False)

# 启用另一个模型
storage.update_model("openai", "gpt-4o", enabled=True)

# 创建新模型实例
model = factory.create_model("openai", "gpt-4o")
```

## 最佳实践

1. **配置管理**：将 API 密钥等敏感信息存储在环境变量或配置文件中
2. **模型复用**：对于相同配置的模型，可以复用实例以提高性能
3. **错误处理**：创建模型时检查返回值，处理可能的 None 情况
4. **供应商选择**：根据任务类型选择合适的供应商和模型
5. **成本控制**：合理设置 max_tokens 和 temperature 参数

## 注意事项

- 创建模型前需要先配置供应商和模型信息
- 模型的 `enabled` 字段为 False 时，`create_model` 会返回 None
- 不同供应商的配置参数可能有差异，请参考各供应商文档
- 使用前需要安装对应供应商的 LangChain 集成包

## 相关依赖

```bash
# OpenAI
pip install langchain-openai

# 通义千问
pip install langchain-community

# Anthropic
pip install langchain-anthropic

# Google
pip install langchain-google-genai
```
