# 模型管理模块 (core/models)

## 概述

`core/models` 是一个完整的模型配置和管理系统，用于统一管理多个 AI 模型供应商和模型实例。支持多种模型类型（文本、嵌入、重排序）和多个供应商（OpenAI、通义千问、Anthropic、Google）。

## 核心组件

### 1. 配置模型 (config.py)

定义了模型配置的数据结构和枚举类型。

**枚举类型：**

- `ModelType`: 模型类型
  - `TEXT`: 文本模型
  - `EMBEDDING`: 嵌入模型
  - `RERANK`: 重排序模型

- `TextMode`: 文本模型模式
  - `LLM`: 语言模型
  - `CHAT`: 聊天模型
  - `VISION`: 视觉模型

- `EmbeddingMode`: 嵌入模型模式
  - `DENSE`: 密集嵌入

**数据类：**

- `ProviderConfig`: 供应商配置
  - `provider_id`: 供应商ID（如 "openai"、"tongyi"）
  - `config_json`: 配置参数字典

- `ModelConfig`: 模型配置
  - `model_id`: 模型ID（如 "gpt-4"）
  - `provider_id`: 所属供应商ID
  - `model_type`: 模型类型
  - `mode`: 模型模式
  - `enabled`: 是否启用

### 2. 存储层 (storage.py)

使用 SQLite 数据库管理模型和供应商配置的持久化存储。

**初始化：**

```python
from core.models import ModelStorage

# 创建存储实例（默认使用 models.db）
storage = ModelStorage()

# 或指定自定义数据库路径
storage = ModelStorage(db_path="custom_path/models.db")
```

**供应商配置操作：**

```python
from core.models import ProviderConfig

# 添加供应商
provider = ProviderConfig(
    provider_id="openai",
    config_json={
        "api_key": "sk-xxx",
        "base_url": "https://api.openai.com/v1",
        "temperature": 0.7,
        "max_tokens": 2000
    }
)
storage.add_provider(provider)

# 获取供应商
provider = storage.get_provider("openai")

# 列出所有供应商
providers = storage.list_providers()

# 更新供应商
provider.config_json["temperature"] = 0.5
storage.update_provider(provider)

# 删除供应商
storage.delete_provider("openai")
```

**模型操作：**

```python
from core.models import ModelConfig, ModelType, TextMode

# 添加模型
model = ModelConfig(
    model_id="gpt-4",
    provider_id="openai",
    model_type=ModelType.TEXT,
    mode=TextMode.CHAT,
    enabled=True
)
storage.add_model(model)

# 获取模型
model = storage.get_model("openai", "gpt-4")

# 列出模型（支持过滤）
# 列出所有启用的模型
all_models = storage.list_models()

# 列出特定供应商的模型
openai_models = storage.list_models(provider_id="openai")

# 列出特定类型的模型
text_models = storage.list_models(model_type=ModelType.TEXT)

# 列出所有模型（包括禁用的）
all_models_including_disabled = storage.list_models(enabled_only=False)

# 更新模型
model.enabled = False
storage.update_model(model)

# 删除模型
storage.delete_model("openai", "gpt-4")

# 获取所有供应商及其模型
providers_with_models = storage.get_providers_with_models()
# 返回格式: {"openai": [ModelConfig, ...], "tongyi": [ModelConfig, ...]}
```

### 3. 工厂类 (factory.py)

根据配置自动创建对应的 LangChain 模型实例。

**初始化：**

```python
from core.models import ModelFactory, ModelStorage

storage = ModelStorage()
factory = ModelFactory(storage)
```

**创建模型实例：**

```python
# 创建模型实例
model = factory.create_model(model_id="gpt-4", provider_id="openai")

# 返回值为 None 的情况：
# 1. 模型不存在
# 2. 模型被禁用
# 3. provider_id 不匹配
# 4. 供应商配置不存在
```

**支持的供应商和模型类型：**

| 供应商 | 模型类型 | 依赖库 |
|--------|---------|--------|
| openai | TEXT, EMBEDDING | langchain_openai |
| tongyi | TEXT | langchain_community |
| anthropic | TEXT | langchain_anthropic |
| google | TEXT, EMBEDDING | langchain_google_genai |

## 使用示例

### 完整工作流

```python
from core.models import (
    ModelStorage, ModelFactory, ModelConfig, ProviderConfig,
    ModelType, TextMode, EmbeddingMode
)

# 1. 初始化存储
storage = ModelStorage(db_path="data/models.db")

# 2. 添加供应商配置
openai_provider = ProviderConfig(
    provider_id="openai",
    config_json={
        "api_key": "sk-xxx",
        "base_url": "https://api.openai.com/v1",
        "temperature": 0.7,
        "max_tokens": 2000
    }
)
storage.add_provider(openai_provider)

# 3. 添加模型
gpt4_model = ModelConfig(
    model_id="gpt-4",
    provider_id="openai",
    model_type=ModelType.TEXT,
    mode=TextMode.CHAT,
    enabled=True
)
storage.add_model(gpt4_model)

embedding_model = ModelConfig(
    model_id="text-embedding-3-small",
    provider_id="openai",
    model_type=ModelType.EMBEDDING,
    mode=EmbeddingMode.DENSE,
    enabled=True
)
storage.add_model(embedding_model)

# 4. 创建工厂并生成模型实例
factory = ModelFactory(storage)

# 创建聊天模型
chat_model = factory.create_model("gpt-4", "openai")
if chat_model:
    response = chat_model.invoke("你好")
    print(response)

# 创建嵌入模型
embed_model = factory.create_model("text-embedding-3-small", "openai")
if embed_model:
    embeddings = embed_model.embed_query("示例文本")
    print(embeddings)

# 5. 查询和管理
# 获取所有启用的模型
enabled_models = storage.list_models(enabled_only=True)

# 禁用某个模型
gpt4_model.enabled = False
storage.update_model(gpt4_model)

# 获取供应商及其所有模型
all_providers = storage.get_providers_with_models()
for provider_id, models in all_providers.items():
    print(f"供应商: {provider_id}")
    for model in models:
        print(f"  - {model.model_id} ({model.model_type.value})")
```

### 多供应商配置

```python
# 添加多个供应商
providers = [
    ProviderConfig(
        provider_id="openai",
        config_json={"api_key": "sk-xxx"}
    ),
    ProviderConfig(
        provider_id="tongyi",
        config_json={"api_key": "sk-xxx"}
    ),
    ProviderConfig(
        provider_id="anthropic",
        config_json={"api_key": "sk-xxx"}
    )
]

for provider in providers:
    storage.add_provider(provider)

# 为每个供应商添加模型
models = [
    ModelConfig("gpt-4", "openai", ModelType.TEXT, TextMode.CHAT),
    ModelConfig("qwen-max", "tongyi", ModelType.TEXT, TextMode.CHAT),
    ModelConfig("claude-3-opus", "anthropic", ModelType.TEXT, TextMode.CHAT),
]

for model in models:
    storage.add_model(model)

# 创建工厂并使用
factory = ModelFactory(storage)
for model_config in storage.list_models():
    model = factory.create_model(model_config.model_id, model_config.provider_id)
    if model:
        print(f"成功创建: {model_config.provider_id}/{model_config.model_id}")
```

## 数据库架构

模块使用 SQLite 数据库，包含两个表：

**provider_config 表：**
- `provider_id` (TEXT, PRIMARY KEY): 供应商ID
- `config_json` (TEXT): JSON 格式的配置参数

**models 表：**
- `provider_id` (TEXT, FOREIGN KEY): 供应商ID
- `model_id` (TEXT): 模型ID
- `model_type` (TEXT): 模型类型
- `mode` (TEXT): 模型模式
- `enabled` (BOOLEAN): 是否启用
- PRIMARY KEY: (provider_id, model_id)

## 最佳实践

1. **配置管理**：将敏感信息（如 API Key）存储在环境变量中，通过 `.env` 文件加载
2. **错误处理**：检查 `create_model()` 返回值是否为 None
3. **数据库路径**：在生产环境中使用专门的数据目录存储数据库
4. **模型启用/禁用**：使用 `enabled` 字段控制模型可用性，而不是删除配置
5. **供应商配置**：定期更新供应商配置中的参数（如温度、最大令牌数）

## 导入方式

```python
# 推荐：从模块导入
from core.models import (
    ModelStorage,
    ModelFactory,
    ModelConfig,
    ProviderConfig,
    ModelType,
    TextMode,
    EmbeddingMode
)

# 或直接导入
from core.models.storage import ModelStorage
from core.models.factory import ModelFactory
from core.models.config import ModelConfig, ProviderConfig, ModelType
```
