# 架构设计文档

## 系统概述

本系统是一个基于 FastAPI 和 LangChain 的多角色 AI Agent 平台，采用分层架构设计，支持多模型供应商、语音识别和语音合成功能。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        API Layer                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │Characters│ │Providers │ │  Models  │ │   TTS    │  ...  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     Business Layer                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              AgentManager (核心管理器)                │   │
│  │  - Agent 生命周期管理                                 │   │
│  │  - 消息处理和路由                                     │   │
│  │  - 缓存管理                                           │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Model   │ │   Tool   │ │Middleware│ │ASR/TTS   │       │
│  │ Factory  │ │ Manager  │ │ Manager  │ │ Factory  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     Storage Layer                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │
│  │   App    │ │  Store   │ │Checkpoint│                    │
│  │ Storage  │ │ (Memory) │ │ (History)│                    │
│  └──────────┘ └──────────┘ └──────────┘                    │
│       ↓             ↓             ↓                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │
│  │  app.db  │ │ store.db │ │checkpoints│                   │
│  └──────────┘ └──────────┘ └──────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. API Layer（API 层）

负责处理 HTTP 请求和响应，提供 RESTful API 接口。

**主要模块**：
- `api/routes/`: 各功能模块的路由定义
- `api/schemas.py`: API 数据模型（Pydantic）

**设计原则**：
- 统一的响应格式（ResponseModel）
- 依赖注入（FastAPI Depends）
- 自动生成 API 文档（Swagger/ReDoc）

### 2. Business Layer（业务层）

核心业务逻辑层，负责 Agent 管理、模型创建、工具管理等。

#### 2.1 AgentManager（Agent 管理器）

**职责**：
- Agent 实例的创建和缓存
- 消息发送和响应处理
- 会话历史管理
- 音频消息处理

**核心方法**：
```python
class AgentManager:
    def get_or_create_agent(character_id, model_id, provider_id, **kwargs)
    def send_message(user_message, conversation_id, ...)
    def send_audio_message(audio, conversation_id, ...)
    def clear_agent_cache(character_id)
```

**缓存策略**：
- 使用 `(character_id, model_id, provider_id)` 作为缓存键
- 当传入动态参数时不使用缓存
- 支持按角色清空缓存

#### 2.2 ModelFactory（模型工厂）

**职责**：
- 管理模型供应商
- 创建模型实例
- 支持自定义供应商注册

**设计模式**：工厂模式 + 策略模式

**核心方法**：
```python
class ModelFactory:
    def register_provider(provider: BaseProvider)
    def create_model(provider_id, model_id, **kwargs)
    def register_custom_openai_provider(provider_id, name, description)
```

**供应商架构**：
```python
class BaseProvider(ABC):
    @abstractmethod
    def create_text_model(model_id, provider_config, **kwargs)
    
    @abstractmethod
    def create_embedding_model(model_id, provider_config, **kwargs)
```

**参数合并策略**：
- 运行时参数（kwargs）> 配置参数（config）> 模型默认值
- 只合并显式提供的参数

#### 2.3 ToolManager（工具管理器）

**职责**：
- 管理工具注册表
- 为角色绑定工具
- 工具实例化

**设计模式**：注册表模式

#### 2.4 MiddlewareManager（中间件管理器）

**职责**：
- 管理中间件
- 为角色绑定中间件
- 中间件链执行

#### 2.5 ASRFactory & TTSFactory

**职责**：
- 创建 ASR/TTS 实例
- 管理语音服务配置
- 支持多提供商

### 3. Storage Layer（存储层）

负责数据持久化和检索。

#### 3.1 AppStorage（应用存储）

**职责**：
- 管理角色、会话、消息、模型、供应商等业务数据
- 基于 SQLite 实现

**数据表**：
- `characters`: 角色配置
- `conversations`: 会话信息
- `messages`: 消息记录
- `providers`: 供应商配置
- `models`: 模型配置
- `character_tools`: 角色-工具关联
- `character_middleware`: 角色-中间件关联

#### 3.2 SqliteStore（长期记忆存储）

**职责**：
- 存储跨会话的长期记忆数据
- 支持命名空间隔离
- 基于 LangGraph 的 Store 接口

#### 3.3 SqliteSaver（检查点存储）

**职责**：
- 存储对话历史和状态
- 支持会话恢复
- 基于 LangGraph 的 Checkpointer 接口

## 数据流

### 消息发送流程

```
1. 用户发送消息
   ↓
2. API Layer 接收请求（POST /messages）
   ↓
3. 验证会话和角色
   ↓
4. AgentManager.send_message()
   ↓
5. 获取或创建 Agent 实例
   ├─ 从缓存获取
   └─ 或创建新实例
      ├─ 获取角色配置（system_prompt）
      ├─ ModelFactory 创建模型
      ├─ ToolManager 获取工具
      ├─ MiddlewareManager 获取中间件
      └─ 创建 Agent
   ↓
6. Agent.invoke() 处理消息
   ├─ 加载对话历史（Checkpointer）
   ├─ 执行中间件
   ├─ 调用模型生成响应
   ├─ 执行工具（如需要）
   └─ 保存检查点
   ↓
7. 存储消息到 AppStorage
   ↓
8. 返回响应
```

### 音频消息流程

```
1. 用户上传音频
   ↓
2. ASRFactory 创建 ASR 实例
   ↓
3. 音频转文本
   ↓
4. 调用文本消息流程
   ↓
5. 获取文本响应
   ↓
6. （可选）TTSFactory 创建 TTS 实例
   ↓
7. 文本转语音
   ↓
8. 返回音频响应
```

## 设计模式

### 1. 工厂模式（Factory Pattern）

**应用场景**：
- `ModelFactory`: 创建不同供应商的模型实例
- `ASRFactory`: 创建不同的 ASR 实例
- `TTSFactory`: 创建不同的 TTS 实例

**优势**：
- 解耦对象创建和使用
- 易于扩展新的供应商
- 统一的创建接口

### 2. 策略模式（Strategy Pattern）

**应用场景**：
- `BaseProvider`: 不同供应商的模型创建策略
- ASR/TTS 的不同实现策略

**优势**：
- 算法可以独立变化
- 避免大量条件判断
- 易于添加新策略

### 3. 单例模式（Singleton Pattern）

**应用场景**：
- `AppStorage`: 全局唯一的存储实例
- `SqliteStore`: 全局唯一的长期记忆存储
- `SqliteSaver`: 全局唯一的检查点存储

**实现方式**：
- 通过 FastAPI 的依赖注入实现
- 使用 `@lru_cache` 装饰器

### 4. 注册表模式（Registry Pattern）

**应用场景**：
- `ToolRegistry`: 工具注册表
- `ModelFactory._providers`: 供应商注册表

**优势**：
- 动态注册和查找
- 解耦注册和使用
- 支持插件化扩展

### 5. 依赖注入（Dependency Injection）

**应用场景**：
- FastAPI 的 `Depends` 机制
- 各层之间的依赖传递

**优势**：
- 降低耦合度
- 易于测试
- 提高可维护性

## 扩展性设计

### 1. 添加新的模型供应商

```python
# 1. 创建供应商类
class NewProvider(BaseProvider):
    @property
    def metadata(self) -> ProviderMetadata:
        return ProviderMetadata(
            provider_id="new_provider",
            name="New Provider",
            description="...",
            config_fields=[...]
        )
    
    def create_text_model(self, model_id, provider_config, **kwargs):
        # 实现模型创建逻辑
        pass

# 2. 注册供应商
model_factory.register_provider(NewProvider())
```

### 2. 添加自定义工具

```python
# 1. 定义工具
@tool
def my_custom_tool(query: str) -> str:
    """工具描述"""
    # 实现工具逻辑
    return result

# 2. 注册工具
tool_registry.register("my_tool", my_custom_tool)

# 3. 绑定到角色
tool_manager.bind_tool_to_character(character_id, "my_tool")
```

### 3. 添加中间件

```python
# 1. 定义中间件
class MyMiddleware:
    def __call__(self, messages, next_handler):
        # 前置处理
        result = next_handler(messages)
        # 后置处理
        return result

# 2. 注册中间件
middleware_manager.register("my_middleware", MyMiddleware())

# 3. 绑定到角色
middleware_manager.bind_middleware_to_character(character_id, "my_middleware")
```

## 性能优化

### 1. Agent 缓存

- 缓存已创建的 Agent 实例
- 避免重复创建模型和工具
- 支持按需清空缓存

### 2. 数据库索引

- 为常用查询字段添加索引
- 优化关联查询性能

### 3. 异步处理

- 支持异步消息发送（`send_message_async`）
- 异步 ASR/TTS 处理

### 4. 连接池

- SQLite 连接复用
- 减少连接开销

## 安全性考虑

### 1. API 密钥管理

- 支持环境变量配置
- 数据库中加密存储（待实现）
- 不在日志中输出敏感信息

### 2. 输入验证

- 使用 Pydantic 进行数据验证
- 防止 SQL 注入（使用参数化查询）
- 文件上传大小限制

### 3. 权限控制

- 待实现：用户认证和授权
- 待实现：角色级别的访问控制

## 可维护性

### 1. 代码组织

- 清晰的分层架构
- 单一职责原则
- 模块化设计

### 2. 配置管理

- YAML 配置文件（ASR/TTS）
- 环境变量（敏感信息）
- 数据库配置（业务数据）

### 3. 日志和监控

- 关键操作日志记录
- 错误追踪
- 性能监控（待完善）

### 4. 测试

- 单元测试（待完善）
- 集成测试（待完善）
- API 测试

## 未来规划

### 1. 功能增强

- [ ] 流式响应支持
- [ ] 多模态输入（图片、视频）
- [ ] 向量数据库集成（RAG）
- [ ] 更多工具和中间件

### 2. 性能优化

- [ ] Redis 缓存
- [ ] 消息队列（异步任务）
- [ ] 负载均衡

### 3. 安全性

- [ ] 用户认证和授权
- [ ] API 密钥加密存储
- [ ] 审计日志

### 4. 可观测性

- [ ] 完善的日志系统
- [ ] 性能监控和告警
- [ ] 分布式追踪

### 5. 部署

- [ ] Docker 容器化
- [ ] Kubernetes 编排
- [ ] CI/CD 流水线
