# 日志系统优化总结

## 优化内容

### 1. 日志分类系统
新增了 7 个分类日志文件：
- `api.log` - HTTP 请求/响应
- `business.log` - 业务逻辑流程
- `database.log` - 数据库操作
- `model.log` - 模型创建和调用
- `performance.log` - 性能监控
- `error.log` - 错误和异常
- `app.log` - 综合日志

### 2. 核心模块日志增强

#### AgentManager (`core/agent_manager.py`)
- Agent 创建和缓存管理
- 消息流式处理过程
- 工具调用追踪
- 错误分类和处理

#### Storage (`core/storage.py`)
- 数据库初始化
- 角色/会话/消息的 CRUD 操作
- 操作成功/失败记录

#### ModelFactory (`core/models/factory.py`)
- 模型实例化过程
- 配置验证
- 模板类型路由

#### ASR/TTS Factory
- 实例创建和缓存
- 配置变更检测
- 提供商切换

### 3. 日志工具增强

#### 性能装饰器 (`@log_performance`)
- 自动记录函数执行时间
- 支持同步/异步函数
- 异常捕获和记录

#### 操作装饰器 (`@log_operation`)
- 记录操作开始/完成
- 支持自定义分类
- 异常追踪

### 4. 结构化日志
所有日志都使用 `extra` 参数添加上下文信息：
```python
logger.info("操作描述", extra={
    "category": "BUSINESS",
    "key1": "value1",
    "key2": "value2"
})
```

## 使用示例

```python
from core.logger import get_logger

# 创建分类 logger
logger = get_logger(__name__, category="BUSINESS")

# 记录业务日志
logger.info("处理消息", extra={
    "conversation_id": 123,
    "message_length": 100
})
```

## 测试方法

运行测试脚本：
```bash
python tests/test_logging.py
```

查看日志文件：
```bash
type logs\app.log
type logs\business.log
type logs\error.log
```

## 文档
详细说明请参考 `docs/日志系统说明.md`
