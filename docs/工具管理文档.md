# 工具管理模块文档

## 概述

工具管理模块提供了统一的工具注册、配置和使用接口。支持三种类型的工具：
- **内置工具**：LangChain 提供的标准工具
- **MCP 工具**：通过 Model Context Protocol 服务器提供的工具
- **自定义工具**：用户自定义的工具

## 核心组件

### 1. ToolRegistry - 工具注册表

管理系统中所有可用的工具。

```python
from core.tools import ToolRegistry

# 初始化（不加载 MCP 工具）
registry = ToolRegistry()

# 初始化并自动加载 MCP 工具
registry = ToolRegistry(
    load_mcp_tools=True,
    mcp_config={
        "servers": {
            "filesystem": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed"]
            }
        }
    }
)
```

### 2. ToolManager - 工具管理器

管理角色的工具配置。

```python
from core.tools import ToolManager, ToolRegistry
from core.storage import AppStorage

# 初始化
storage = AppStorage("data/app.db")
registry = ToolRegistry()
manager = ToolManager(storage, registry)

# 获取角色的工具
tools = manager.get_character_tools(character_id=1)
```

## 使用示例

### 示例 1：注册和使用内置工具

```python
from langchain_community.tools import WikipediaQueryRun
from langchain_community.utilities import WikipediaAPIWrapper
from core.tools import ToolRegistry

# 创建工具实例
wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())

# 注册工具
registry = ToolRegistry()
registry.register_tool(
    tool=wikipedia,
    category="builtin",
    description="搜索维基百科"
)

# 列出所有工具
tools = registry.list_tools()
print(tools)
```


### 示例 2：配置角色工具

```python
from core.storage import AppStorage
from core.tools import ToolManager, ToolRegistry

# 初始化
storage = AppStorage("data/app.db")
registry = ToolRegistry()
manager = ToolManager(storage, registry)

# 先注册工具到注册表
from langchain_community.tools import DuckDuckGoSearchRun
search_tool = DuckDuckGoSearchRun()
registry.register_tool(search_tool, category="builtin")

# 为角色添加工具
manager.add_character_tool(
    character_id=1,
    tool_name="duckduckgo_search",
    enabled=True
)

# 获取角色的所有工具
tools = manager.get_character_tools(character_id=1)
print(f"角色拥有 {len(tools)} 个工具")
```

### 示例 3：使用 MCP 工具

```python
from core.tools import ToolRegistry

# 配置 MCP 服务器
mcp_config = {
    "servers": {
        "filesystem": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "C:/workspace"]
        },
        "github": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-github"],
            "env": {
                "GITHUB_TOKEN": "ghp_xxx"
            }
        }
    }
}

# 初始化并加载 MCP 工具
registry = ToolRegistry(load_mcp_tools=True, mcp_config=mcp_config)

# 列出所有 MCP 服务器
servers = registry.list_mcp_servers()
print(f"可用的 MCP 服务器: {servers}")

# 列出所有 MCP 工具
mcp_tools = registry.list_tools(category="mcp")
for tool in mcp_tools:
    print(f"- {tool['name']}: {tool['description']}")
```

### 示例 4：在 Agent 中使用工具

```python
from core.agent_manager import AgentManager

# 创建 Agent 管理器
agent_manager = AgentManager(
    db_path="data/app.db",
    store_path="data/store.db"
)

# 注册工具
from langchain_community.tools import WikipediaQueryRun
from langchain_community.utilities import WikipediaAPIWrapper

wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())
agent_manager.tool_registry.register_tool(wikipedia, category="builtin")

# 创建角色并添加工具
character_id = agent_manager.create_character(
    name="研究助手",
    system_prompt="你是一个研究助手，可以搜索维基百科",
    model_provider="openai",
    model_id="gpt-4o-mini"
)

agent_manager.tool_manager.add_character_tool(
    character_id=character_id,
    tool_name="wikipedia",
    enabled=True
)

# 创建 Agent（工具会自动绑定）
agent = agent_manager.create_agent(character_id)

# 使用工具
response = agent.invoke({
    "messages": [("user", "搜索一下 LangChain 的信息")]
})
print(response["messages"][-1].content)
```

### 示例 5：动态管理工具

```python
# 禁用某个工具
manager.update_character_tool(
    character_id=1,
    tool_name="wikipedia",
    enabled=False
)

# 移除工具
manager.remove_character_tool(
    character_id=1,
    tool_name="wikipedia"
)

# 重新添加工具
manager.add_character_tool(
    character_id=1,
    tool_name="duckduckgo_search",
    enabled=True
)
```

### 示例 6：自定义工具

```python
from langchain_core.tools import tool

@tool
def calculate(expression: str) -> str:
    """计算数学表达式
    
    Args:
        expression: 数学表达式，如 "2 + 2"
    """
    try:
        result = eval(expression)
        return f"结果是: {result}"
    except Exception as e:
        return f"计算错误: {e}"

# 注册自定义工具
registry.register_tool(
    tool=calculate,
    category="custom",
    description="计算数学表达式"
)

# 为角色添加自定义工具
manager.add_character_tool(
    character_id=1,
    tool_name="calculate",
    enabled=True
)
```

## 常用工具推荐

### 搜索工具

```python
# DuckDuckGo 搜索
from langchain_community.tools import DuckDuckGoSearchRun
search = DuckDuckGoSearchRun()

# 维基百科
from langchain_community.tools import WikipediaQueryRun
from langchain_community.utilities import WikipediaAPIWrapper
wikipedia = WikipediaQueryRun(api_wrapper=WikipediaAPIWrapper())

# Tavily 搜索（需要 API key）
from langchain_community.tools.tavily_search import TavilySearchResults
tavily = TavilySearchResults(api_key="tvly-xxx")
```

### 文件操作工具（MCP）

```python
# 文件系统工具
mcp_config = {
    "servers": {
        "filesystem": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"]
        }
    }
}
registry = ToolRegistry(load_mcp_tools=True, mcp_config=mcp_config)
```

### 代码执行工具

```python
from langchain_experimental.tools import PythonREPLTool
python_repl = PythonREPLTool()
registry.register_tool(python_repl, category="builtin")
```

## MCP 工具配置

### 常用 MCP 服务器

| 服务器 | 功能 | 配置示例 |
|--------|------|----------|
| filesystem | 文件操作 | `npx -y @modelcontextprotocol/server-filesystem /path` |
| github | GitHub 操作 | `npx -y @modelcontextprotocol/server-github` |
| postgres | 数据库操作 | `npx -y @modelcontextprotocol/server-postgres` |
| puppeteer | 浏览器自动化 | `npx -y @modelcontextprotocol/server-puppeteer` |

### MCP 配置示例

```python
mcp_config = {
    "servers": {
        "filesystem": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "C:/workspace"],
            "env": {}
        },
        "github": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-github"],
            "env": {
                "GITHUB_TOKEN": "ghp_xxx"
            }
        }
    }
}
```

## 工具分类管理

```python
# 按分类列出工具
builtin_tools = registry.list_tools(category="builtin")
mcp_tools = registry.list_tools(category="mcp")
custom_tools = registry.list_tools(category="custom")

print(f"内置工具: {len(builtin_tools)}")
print(f"MCP 工具: {len(mcp_tools)}")
print(f"自定义工具: {len(custom_tools)}")
```

## 最佳实践

1. **工具命名**：使用清晰、描述性的工具名称
2. **工具描述**：提供详细的工具描述，帮助 Agent 理解何时使用
3. **权限控制**：MCP 工具要限制访问路径，避免安全风险
4. **错误处理**：工具应该优雅地处理错误并返回有意义的错误信息
5. **性能考虑**：避免在工具中执行耗时操作，考虑使用异步
6. **工具组合**：为不同角色配置不同的工具组合

## 注意事项

- MCP 工具需要安装 `langchain-mcp-adapters` 包
- 某些工具可能需要额外的 API 密钥或配置
- 工具的执行结果会影响 Agent 的行为，需要仔细测试
- 过多的工具可能导致 Agent 选择困难，建议精简工具集
- MCP 服务器需要 Node.js 环境

## 相关依赖

```bash
# 基础依赖
pip install langchain-core langchain-community

# MCP 支持
pip install langchain-mcp-adapters

# 特定工具依赖
pip install wikipedia duckduckgo-search tavily-python
```

## 故障排查

### MCP 工具无法加载

```python
# 检查 MCP 是否可用
if registry.is_mcp_available():
    print("MCP 已初始化")
else:
    print("MCP 未初始化，请检查配置")

# 手动加载 MCP 工具
count = registry.load_mcp_tools()
print(f"加载了 {count} 个 MCP 工具")
```

### 工具未找到

```python
# 检查工具是否已注册
tool = registry.get_tool("tool_name")
if tool is None:
    print("工具未注册")
else:
    print(f"工具已注册: {tool.name}")
```

### 角色无法使用工具

```python
# 检查角色的工具配置
tools = manager.get_character_tools(character_id=1)
if not tools:
    print("角色没有配置任何工具")
else:
    print(f"角色拥有 {len(tools)} 个工具")
```
