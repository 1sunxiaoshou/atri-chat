# 自定义供应商使用指南

## 概述

系统支持添加任意 OpenAI 兼容协议的自定义供应商，无需修改代码。

## 支持的供应商类型

### 内置供应商
- `openai` - OpenAI GPT 模型
- `anthropic` - Anthropic Claude 模型
- `google` - Google Gemini 模型
- `tongyi` - 阿里通义千问
- `local` - 本地模型（Ollama）

### 自定义供应商
任何支持 OpenAI API 协议的第三方服务，例如：
- DeepSeek
- Moonshot (月之暗面)
- 智谱 AI (GLM)
- 百川智能
- MiniMax
- 零一万物
- 其他兼容 OpenAI 协议的服务

## 使用方法

### 方式一：自动注册（推荐）

直接创建供应商配置，系统会自动识别并注册为 OpenAI 兼容供应商：

```bash
# 1. 创建供应商配置（自动注册）
POST /api/v1/providers
{
  "provider_id": "deepseek",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.deepseek.com/v1"
  }
}

# 响应
{
  "code": 200,
  "message": "供应商创建成功",
  "data": {
    "provider_id": "deepseek",
    "type": "custom_openai_compatible",
    "auto_registered": true
  }
}

# 2. 添加模型
POST /api/v1/models
{
  "provider_id": "deepseek",
  "model_id": "deepseek-chat",
  "model_type": "text",
  "capabilities": ["chat"],
  "enabled": true
}

# 3. 使用模型
POST /api/v1/messages/send
{
  "conversation_id": 1,
  "character_id": 1,
  "model_id": "deepseek-chat",
  "provider_id": "deepseek",
  "content": "你好"
}
```

### 方式二：预注册（可选）

如果想在创建配置前就在支持列表中显示：

```bash
# 1. 预注册供应商
POST /api/v1/providers/custom/openai-compatible?provider_id=moonshot&name=Moonshot%20AI&description=月之暗面

# 2. 创建配置
POST /api/v1/providers
{
  "provider_id": "moonshot",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.moonshot.cn/v1"
  }
}
```

## 常见自定义供应商配置

### DeepSeek

```json
{
  "provider_id": "deepseek",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.deepseek.com/v1"
  }
}
```

### Moonshot (月之暗面)

```json
{
  "provider_id": "moonshot",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.moonshot.cn/v1"
  }
}
```

### 智谱 AI (GLM)

```json
{
  "provider_id": "zhipu",
  "config_json": {
    "api_key": "xxx.xxx",
    "base_url": "https://open.bigmodel.cn/api/paas/v4"
  }
}
```

### 百川智能

```json
{
  "provider_id": "baichuan",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.baichuan-ai.com/v1"
  }
}
```

### 零一万物

```json
{
  "provider_id": "yi",
  "config_json": {
    "api_key": "xxx",
    "base_url": "https://api.lingyiwanwu.com/v1"
  }
}
```

## 参数配置

### 全局默认参数

可以在供应商配置中设置默认参数：

```json
{
  "provider_id": "deepseek",
  "config_json": {
    "api_key": "sk-xxx",
    "base_url": "https://api.deepseek.com/v1",
    "temperature": 0.7,
    "max_tokens": 2000
  }
}
```

### 运行时参数

创建模型时可以覆盖默认参数：

```python
# 在代码中
model = factory.create_model(
    "deepseek", 
    "deepseek-chat", 
    temperature=0.9,  # 覆盖配置中的默认值
    max_tokens=4000
)
```

### 参数优先级

```
运行时参数 > 配置参数 > 模型默认值
```

## 查询接口

### 查看所有支持的供应商

```bash
GET /api/v1/providers/supported/list
```

返回内置供应商和已注册的自定义供应商。

### 查看自定义供应商列表

```bash
GET /api/v1/providers/custom/openai-compatible
```

### 查看已配置的供应商

```bash
GET /api/v1/providers
```

## 注意事项

1. **必需字段**：自定义供应商必须提供 `base_url` 配置
2. **协议兼容**：确保目标服务支持 OpenAI API 协议
3. **模型名称**：使用服务商提供的准确模型名称
4. **API Key**：确保 API Key 有效且有足够的配额
5. **网络访问**：确保服务器能访问目标 API 地址

## 故障排查

### 问题：创建模型失败

检查：
- `base_url` 是否正确（通常以 `/v1` 结尾）
- `api_key` 是否有效
- 网络是否能访问目标地址

### 问题：模型调用失败

检查：
- `model_id` 是否正确
- API Key 是否有足够配额
- 查看错误日志获取详细信息

## 完整示例

```bash
# 1. 添加 DeepSeek 供应商
curl -X POST http://localhost:8000/api/v1/providers \
  -H "Content-Type: application/json" \
  -d '{
    "provider_id": "deepseek",
    "config_json": {
      "api_key": "sk-xxx",
      "base_url": "https://api.deepseek.com/v1",
      "temperature": 0.7
    }
  }'

# 2. 添加模型
curl -X POST http://localhost:8000/api/v1/models \
  -H "Content-Type: application/json" \
  -d '{
    "provider_id": "deepseek",
    "model_id": "deepseek-chat",
    "model_type": "text",
    "capabilities": ["chat"],
    "enabled": true
  }'

# 3. 创建角色
curl -X POST http://localhost:8000/api/v1/characters \
  -H "Content-Type: application/json" \
  -d '{
    "name": "DeepSeek助手",
    "description": "使用DeepSeek模型的AI助手",
    "system_prompt": "你是一个友好的AI助手",
    "primary_model_id": "deepseek-chat",
    "primary_provider_id": "deepseek",
    "tts_id": "default-tts",
    "enabled": true
  }'

# 4. 创建会话并对话
curl -X POST http://localhost:8000/api/v1/conversations \
  -H "Content-Type: application/json" \
  -d '{
    "character_id": 1,
    "title": "测试对话"
  }'

curl -X POST http://localhost:8000/api/v1/messages/send \
  -H "Content-Type: application/json" \
  -d '{
    "conversation_id": 1,
    "character_id": 1,
    "model_id": "deepseek-chat",
    "provider_id": "deepseek",
    "content": "你好，请介绍一下你自己"
  }'
```
