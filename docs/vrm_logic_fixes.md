# VRM模块逻辑问题修复报告

## 修复日期
2025-12-12

## 发现的严重问题

### 1. 句子分割逻辑错误 (`audio_generator.py`)

**问题描述：**
- 原算法先移除标记再分割句子，然后尝试在原文中"回溯匹配"带标记的句子
- 当标记位于句子中间时，回溯匹配会失败，导致句子边界错误
- 复杂的查找逻辑容易出现位置偏移错误

**修复方案：**
- 使用正向扫描算法，直接在带标记的文本上分割
- 遇到标记时跳过整个标记块，遇到句子结束符时完成分割
- 避免回溯匹配，确保句子边界准确

**测试验证：**
```python
# 测试用例：标记在句子中间
text = "你好[State:开心]世界！今天[Action:挠头]很好。"
sentences = generator.split_sentences(text)
# 结果：['你好[State:开心]世界！', '今天[Action:挠头]很好。']
```

### 2. 标记位置计算错误 (`markup_parser.py`)

**问题描述：**
- 使用 `original_position - offset` 计算标记在纯文本中的位置
- 当标记不连续时，offset累积会出错
- 例如：`"你好[State:开心]世界"` 中标记位置计算错误

**修复方案：**
- 使用正向扫描，实时维护纯文本字符列表
- 标记位置 = 当前纯文本长度（`len(clean_chars)`）
- 避免offset累积，确保位置计算精确

**测试验证：**
```python
# 测试用例：标记在中间
text = "你好[State:开心]世界"
clean, markups = parser.parse(text)
# clean = "你好世界"
# markups[0].position = 2  # 正确位置
```

### 3. 时间戳计算不准确 (`audio_generator.py`)

**问题描述：**
- 简单使用 `position / text_length` 计算相对位置
- 没有考虑句首、句尾标记的特殊语义
- 句尾标记可能在音频结束后才触发

**修复方案：**
- 句首标记（position=0）：触发时间 = 句子开始时间
- 句尾标记（position≥text_length）：提前0.1秒触发
- 中间标记：使用线性插值（简化处理）

**改进效果：**
- 句首表情和动作立即触发
- 句尾标记不会延迟到下一句
- 时间戳更符合实际语义

### 4. system_prompt并发修改问题 (`agent_manager.py`)

**问题描述：**
- 在 `send_message_stream_vrm` 中临时修改数据库中的 `system_prompt`
- 多个请求同时进来会相互覆盖
- 异常时的恢复逻辑可能失败

**修复方案：**
- 不修改数据库，在内存中创建临时角色配置
- 使用 `character.copy()` 创建副本，修改副本的 `system_prompt`
- 直接使用修改后的prompt创建agent，避免并发冲突
- 移除异常恢复逻辑（不再需要）

**改进效果：**
- 完全避免并发问题
- 代码更简洁，无需恢复逻辑
- 性能更好（减少数据库写操作）

## 测试结果

所有测试用例通过：
- ✓ 标记在开头
- ✓ 标记在中间
- ✓ 多个标记
- ✓ 标记在末尾
- ✓ 简单句子分割
- ✓ 标记在句子中间
- ✓ 连续标记
- ✓ 没有标点符号

## 影响范围

修改的文件：
1. `core/vrm/audio_generator.py` - 句子分割和时间戳计算
2. `core/vrm/markup_parser.py` - 标记位置计算
3. `core/agent_manager.py` - system_prompt并发问题

## 建议

1. **后续优化**：时间戳计算可以考虑使用更精确的算法（如基于音素对齐）
2. **监控**：添加日志监控标记解析和时间戳计算的准确性
3. **测试**：在实际场景中测试VRM动作和表情的触发时机

## 后续改进

### 5. 动作映射动态化 (2025-12-12)

**问题描述：**
- `markup_parser.py` 中的动作映射是硬编码的常量
- 无法支持用户自定义的VRM动作
- 每次添加新动作都需要修改代码

**改进方案：**
- 将动作映射改为构造函数参数，从数据库动态获取
- `VRMMarkupParser` 接收 `action_mapping` 参数
- `AudioGenerator` 从数据库读取角色关联的VRM模型的动作列表
- `agent_manager.py` 在创建音频生成器时传入动作映射

**改进效果：**
- 支持用户自定义动作，无需修改代码
- 不同VRM模型可以有不同的动作集
- 未知动作会记录警告日志，并保留原始中文名

**测试验证：**
- ✓ 自定义动作映射
- ✓ 未知动作保留原始中文名
- ✓ 空映射时的降级处理
- ✓ 表情映射不受影响（固定映射）
- ✓ 混合使用表情和自定义动作

## 总结

本次修复解决了VRM模块的4个严重逻辑问题，并进行了1项重要改进：
1. 句子分割逻辑 - 正向扫描替代回溯匹配
2. 标记位置计算 - 实时维护纯文本长度
3. 时间戳计算 - 特殊处理句首/句尾标记
4. 并发问题 - 内存中修改prompt
5. 动作映射动态化 - 从数据库获取，支持自定义

所有修复和改进都通过了单元测试验证，代码质量和可扩展性得到显著提升。
