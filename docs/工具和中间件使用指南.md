# 工具和中间件使用指南

## 概述

本系统支持为 Agent 配置工具（Tools）和中间件（Middleware），实现灵活的功能扩展。

### 核心特性

1. **工具管理**
   - 支持内置工具（LangChain 工具）
   - 支持 MCP 工具（通过 Model Context Protocol）
   - 支持自定义工具
   - 角色级别的工具配置（选配模式）

2. **中间件管理**
   - 支持 SummarizationMiddleware（对话摘要）
   - 可配置的触发条件和保留策略
   - 角色级别的中间件配置
   - 配置持久化到数据库

3. **MCP 集成**
   - 使用 `langchain-mcp-adapters` 库
   - 支持多个 MCP 服务器
   - 动态加载 MCP 工具

## 架构设计

```
AgentManager
├── ToolRegistry (工具注册表)
│   ├── 内置工具
│   ├── MCP 工具
│   └── 自定义工具
├── ToolManager (工具管理器)
│   └── 角色工具配置
├── MiddlewareManager (中间件管理器)
│   └── 角色中间件配置
└── MCPAdapter (MCP 适配器)
    └── MCP 服务器连接
```

## 数据库表结构

### character_tools 表
```sql
CREATE TABLE character_tools (
    character_id INTEGER NOT NULL,
    tool_name TEXT NOT NULL,
    enabled BOOLEAN DEFAULT 1,
    PRIMARY KEY (character_id, tool_name)
);
```

### character_middleware 表
```sql
CREATE TABLE character_middleware (
    character_id INTEGER PRIMARY KEY,
    config_json TEXT NOT NULL
);
```

## 使用示例

### 1. 初始化系统

```python
from core.storage import AppStorage
from core.store import SqliteStore
from core.agent_manager import AgentManager
from core.tools.registry import ToolRegistry
from core.tools.mcp_adapter import MCPAdapter
from langgraph.checkpoint.sqlite import SqliteSaver

# 初始化存储
app_storage = AppStorage("data/app.db")
store = SqliteStore("data/store.db")
checkpointer = SqliteSaver.from_conn_string("data/checkpoints.db")

# 创建工具注册表
tool_registry = ToolRegistry()

# 创建 AgentManager
agent_manager = AgentManager(
    app_storage=app_storage,
    store=store,
    checkpointer=checkpointer,
    tool_registry=tool_registry
)
```

### 2. 注册工具

#### 注册内置工具
```python
from langchain_community.tools import WikipediaQueryRun, DuckDuckGoSearchRun

# 注册 Wikipedia 工具
wiki_tool = WikipediaQueryRun()
tool_registry.register_tool(wiki_tool, category="builtin")

# 注册搜索工具
search_tool = DuckDuckGoSearchRun()
tool_registry.register_tool(search_tool, category="builtin")
```

#### 注册 MCP 工具
```python
# 初始化 MCP 适配器
mcp_adapter = MCPAdapter()
mcp_adapter.initialize()

# 加载 MCP 工具
if mcp_adapter.is_available():
    mcp_tools = mcp_adapter.load_tools()
    tool_registry.register_mcp_tools(mcp_tools)
    print(f"已加载 {len(mcp_tools)} 个 MCP 工具")
```

### 3. 为角色配置工具

```python
character_id = 1

# 添加工具
agent_manager.tool_manager.add_character_tool(
    character_id=character_id,
    tool_name="wikipedia",
    enabled=True
)

agent_manager.tool_manager.add_character_tool(
    character_id=character_id,
    tool_name="duckduckgo_search",
    enabled=True
)

# 查看角色的工具
tools = agent_manager.app_storage.list_character_tools(character_id)
for tool in tools:
    print(f"{tool['tool_name']}: {'启用' if tool['enabled'] else '禁用'}")

# 禁用某个工具
agent_manager.tool_manager.update_character_tool(
    character_id=character_id,
    tool_name="wikipedia",
    enabled=False
)

# 移除工具
agent_manager.tool_manager.remove_character_tool(
    character_id=character_id,
    tool_name="wikipedia"
)
```

### 4. 配置中间件

#### 配置摘要中间件
```python
# 更新摘要配置
agent_manager.middleware_manager.update_summarization_config(
    character_id=character_id,
    enabled=True,
    model="gpt-4o-mini",
    trigger_tokens=4000,      # 当消息超过 4000 tokens 时触发
    trigger_messages=None,    # 可选：按消息数触发
    keep_messages=20          # 保留最近 20 条消息
)

# 查看配置
config = agent_manager.app_storage.get_middleware_config(character_id)
print(f"中间件配置: {config}")
```

#### 使用配置对象
```python
from core.middleware.config import MiddlewareConfig, SummarizationConfig

# 创建配置
config = MiddlewareConfig(
    character_id=character_id,
    summarization=SummarizationConfig(
        enabled=True,
        model="gpt-4o-mini",
        trigger_tokens=4000,
        keep_messages=20
    )
)

# 保存配置
agent_manager.middleware_manager.save_middleware_config(character_id, config)
```

### 5. 使用配置好的 Agent

```python
# 清空缓存以使用新配置
agent_manager.clear_agent_cache(character_id)

# 发送消息
response = agent_manager.send_message(
    user_message="请搜索一下最新的 AI 新闻",
    conversation_id=1,
    character_id=character_id,
    model_id="qwen-plus",
    provider_id="dashscope"
)

print(f"助手回复: {response}")
```

## MCP 配置

### 安装 MCP 适配器
```bash
pip install langchain-mcp-adapters
```

### MCP 服务器配置示例

创建 MCP 配置文件（可选）：
```python
mcp_config = {
    "servers": [
        {
            "name": "filesystem",
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed/files"]
        },
        {
            "name": "github",
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-github"],
            "env": {
                "GITHUB_PERSONAL_ACCESS_TOKEN": "your_token_here"
            }
        }
    ]
}

mcp_adapter = MCPAdapter()
mcp_adapter.initialize(mcp_config)
```

### 列出可用的 MCP 服务器
```python
servers = mcp_adapter.list_servers()
print(f"可用服务器: {servers}")
```

### 加载特定服务器的工具
```python
# 只加载 filesystem 服务器的工具
fs_tools = mcp_adapter.load_tools(server_name="filesystem")
tool_registry.register_mcp_tools(fs_tools)
```

## 工具和中间件的工作流程

### Agent 创建流程
```
1. 获取角色配置（system_prompt 等）
2. 创建模型实例
3. 从 ToolManager 获取角色的工具列表
4. 从 MiddlewareManager 获取角色的中间件列表
5. 创建 Agent 实例（包含工具和中间件）
6. 缓存 Agent 实例
```

### 消息处理流程
```
1. 用户发送消息
2. Agent 接收消息
3. Middleware 预处理（如摘要检查）
4. 模型推理（可能调用工具）
5. 工具执行
6. Middleware 后处理
7. 返回响应
8. 保存消息到数据库
```

## 最佳实践

1. **工具选择**
   - 根据角色的功能需求选择合适的工具
   - 避免为角色配置过多工具（影响性能）
   - 定期审查和清理不使用的工具

2. **中间件配置**
   - 根据对话长度调整 `trigger_tokens`
   - 保留足够的最近消息（`keep_messages`）以保持上下文
   - 使用较小的模型进行摘要以节省成本

3. **MCP 集成**
   - 确保 MCP 服务器配置正确
   - 处理 MCP 工具加载失败的情况
   - 定期更新 MCP 工具列表

4. **性能优化**
   - 使用 Agent 缓存减少重复创建
   - 配置更新后清空缓存
   - 监控工具调用的性能

## 故障排查

### MCP 工具无法加载
```python
# 检查 MCP 是否可用
if not mcp_adapter.is_available():
    print("MCP 不可用，请安装: pip install langchain-mcp-adapters")

# 检查服务器列表
servers = mcp_adapter.list_servers()
if not servers:
    print("没有配置 MCP 服务器")
```

### 工具未生效
```python
# 检查工具是否已注册
tool = tool_registry.get_tool("tool_name")
if not tool:
    print("工具未注册")

# 检查角色工具配置
tools = agent_manager.app_storage.list_character_tools(character_id)
print(f"角色工具: {tools}")

# 清空缓存
agent_manager.clear_agent_cache(character_id)
```

### 中间件未生效
```python
# 检查配置
config = agent_manager.app_storage.get_middleware_config(character_id)
if not config:
    print("未配置中间件")
else:
    print(f"中间件配置: {config}")

# 清空缓存
agent_manager.clear_agent_cache(character_id)
```

## 扩展开发

### 添加自定义工具
```python
from langchain_core.tools import BaseTool
from pydantic import BaseModel, Field

class MyCustomToolInput(BaseModel):
    query: str = Field(description="查询参数")

class MyCustomTool(BaseTool):
    name = "my_custom_tool"
    description = "我的自定义工具"
    args_schema = MyCustomToolInput
    
    def _run(self, query: str) -> str:
        # 实现工具逻辑
        return f"处理结果: {query}"

# 注册工具
custom_tool = MyCustomTool()
tool_registry.register_tool(custom_tool, category="custom")
```

### 添加新的中间件类型

1. 在 `core/middleware/config.py` 中添加配置类
2. 在 `core/middleware/manager.py` 中添加创建方法
3. 更新数据库配置结构

## 参考资料

- [LangChain Agents 文档](https://docs.langchain.com/oss/python/langchain/agents)
- [LangChain Middleware 文档](https://docs.langchain.com/oss/python/langchain/middleware/built-in)
- [Model Context Protocol](https://docs.langchain.com/oss/python/langchain/mcp)
- [SummarizationMiddleware API](https://docs.langchain.com/oss/python/langchain/middleware/built-in#summarization)
