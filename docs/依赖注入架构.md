# 依赖注入架构说明

## 概述

本系统采用 FastAPI 的依赖注入（Dependency Injection）机制管理核心组件，遵循工程最佳实践。

## 核心组件

### 1. 单例管理器 (`core/dependencies.py`)

```python
from functools import lru_cache

@lru_cache()
def get_app_storage() -> AppStorage:
    """获取 AppStorage 单例"""
    return AppStorage(db_path="data/app.db")

@lru_cache()
def get_store() -> SqliteStore:
    """获取 SqliteStore 单例"""
    return SqliteStore(db_path="data/store.db")

@lru_cache()
def get_checkpointer() -> SqliteSaver:
    """获取 SqliteSaver 单例"""
    conn = sqlite3.connect("data/checkpoints.db", check_same_thread=False)
    return SqliteSaver(conn)

@lru_cache()
def get_agent_manager() -> AgentManager:
    """获取 AgentManager 单例"""
    return AgentManager(
        app_storage=get_app_storage(),
        store=get_store(),
        checkpointer=get_checkpointer()
    )
```

### 2. FastAPI 依赖项

```python
def get_storage() -> Generator[AppStorage, None, None]:
    """FastAPI 依赖：获取 AppStorage"""
    yield get_app_storage()

def get_agent() -> Generator[AgentManager, None, None]:
    """FastAPI 依赖：获取 AgentManager"""
    yield get_agent_manager()
```

## 使用方式

### 在路由中注入依赖

```python
from fastapi import APIRouter, Depends
from core.dependencies import get_storage, get_agent

router = APIRouter()

@router.post("/messages/send")
async def send_message(
    req: MessageRequest,
    agent_manager: AgentManager = Depends(get_agent)
):
    """发送消息 - 自动注入 AgentManager"""
    response = agent_manager.send_message(
        user_message=req.content,
        conversation_id=req.conversation_id,
        character_id=req.character_id,
        model_id=req.model_id,
        provider_id=req.provider_id
    )
    return ResponseModel(data={"response": response})

@router.get("/characters")
async def list_characters(
    enabled_only: bool = True,
    app_storage: AppStorage = Depends(get_storage)
):
    """列出角色 - 自动注入 AppStorage"""
    characters = app_storage.list_characters(enabled_only)
    return ResponseModel(data=characters)
```

## 架构优势

### 1. 单例保证
- 使用 `@lru_cache()` 确保每个组件全局唯一
- 避免重复创建数据库连接和实例
- 减少内存占用和初始化开销

### 2. 线程安全
- `@lru_cache()` 自动处理并发访问
- 适合多线程和异步环境
- 无需手动加锁

### 3. 易于测试
```python
from fastapi.testclient import TestClient
from core.dependencies import get_storage

# Mock 依赖
def get_mock_storage():
    return MockAppStorage()

app.dependency_overrides[get_storage] = get_mock_storage

# 测试
client = TestClient(app)
response = client.get("/api/v1/characters")
```

### 4. 清晰的依赖关系
- 每个函数明确声明需要的依赖
- 代码可读性强
- 便于理解和维护

### 5. 符合 FastAPI 最佳实践
- 官方推荐的依赖管理方式
- 与 FastAPI 生态系统完美集成
- 支持嵌套依赖和依赖链

## 生命周期管理

### 应用启动时

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    """应用生命周期管理"""
    print("初始化系统...")
    
    # 预热单例实例（触发初始化）
    get_app_storage()
    checkpointer = get_checkpointer()
    
    print("✓ 系统初始化完成")
    
    yield
    
    # 关闭资源
    print("关闭系统...")
    if hasattr(checkpointer, 'conn') and checkpointer.conn:
        checkpointer.conn.close()
    print("✓ 系统已关闭")
```

### 请求处理时

1. FastAPI 接收请求
2. 解析路由和依赖
3. 调用 `Depends(get_storage)` 或 `Depends(get_agent)`
4. 从缓存获取单例实例（首次调用时创建）
5. 注入到路由函数
6. 执行业务逻辑
7. 返回响应

## 与旧架构对比

### 旧架构（全局变量）

```python
# main.py
app_storage: AppStorage = None
agent_manager: AgentManager = None

@asynccontextmanager
async def lifespan(app: FastAPI):
    global app_storage, agent_manager
    app_storage = AppStorage()
    agent_manager = AgentManager(app_storage, ...)
    
    # 手动注入到路由
    characters.set_dependencies(app_storage, agent_manager)
    yield

# routes/characters.py
app_storage: AppStorage = None
agent_manager: AgentManager = None

def set_dependencies(storage, manager):
    global app_storage, agent_manager
    app_storage = storage
    agent_manager = manager

@router.post("/characters")
async def create_character(req: CharacterRequest):
    # 直接使用全局变量
    character_id = app_storage.add_character(...)
```

**问题**：
- 全局变量污染
- 难以测试（无法 mock）
- 不符合 FastAPI 规范
- 依赖关系不明确

### 新架构（依赖注入）

```python
# core/dependencies.py
@lru_cache()
def get_app_storage() -> AppStorage:
    return AppStorage()

def get_storage() -> Generator[AppStorage, None, None]:
    yield get_app_storage()

# routes/characters.py
@router.post("/characters")
async def create_character(
    req: CharacterRequest,
    app_storage: AppStorage = Depends(get_storage)
):
    # 通过依赖注入获取实例
    character_id = app_storage.add_character(...)
```

**优势**：
- 无全局变量
- 易于测试
- 符合 FastAPI 规范
- 依赖关系清晰

## 扩展示例

### 添加新的依赖

```python
# core/dependencies.py
@lru_cache()
def get_redis_client() -> Redis:
    """获取 Redis 客户端单例"""
    return Redis(host='localhost', port=6379)

def get_cache() -> Generator[Redis, None, None]:
    """FastAPI 依赖：获取 Redis"""
    yield get_redis_client()

# routes/xxx.py
@router.get("/cached-data")
async def get_cached_data(
    cache: Redis = Depends(get_cache)
):
    data = cache.get("key")
    return ResponseModel(data=data)
```

### 嵌套依赖

```python
def get_current_user(token: str = Header(...)) -> User:
    """验证 token 并返回当前用户"""
    # 验证逻辑
    return user

@router.get("/profile")
async def get_profile(
    current_user: User = Depends(get_current_user),
    app_storage: AppStorage = Depends(get_storage)
):
    """需要认证的接口"""
    profile = app_storage.get_user_profile(current_user.id)
    return ResponseModel(data=profile)
```

## 总结

依赖注入是现代 Web 框架的标准做法，本系统完全遵循 FastAPI 的最佳实践：

- ✅ 使用 `@lru_cache()` 实现单例
- ✅ 使用 `Depends()` 注入依赖
- ✅ 避免全局变量
- ✅ 易于测试和扩展
- ✅ 线程安全
- ✅ 代码清晰可维护
